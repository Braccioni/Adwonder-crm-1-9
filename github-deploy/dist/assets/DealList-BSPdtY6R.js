import{r as o,z as x,j as e,X as k,C as w,B as T}from"./index-DgQnJBRP.js";import{d as y}from"./dealService-BGrHSSP5.js";import{c as F}from"./clientService-DOg-DVUb.js";import{d as A,Z as I}from"./validation-cuF-1e0r.js";import{P as q,S as P,a as L,T as V}from"./trash-2-ZARSRhba.js";import{E as O}from"./euro-ho5eT_Bs.js";import{f as M,i as B}from"./it-Byu6YFuj.js";import"./cacheManager-C0Kc18OK.js";const R=({deal:r,onSubmit:b,onClose:p})=>{const[j,N]=o.useState([]),[a,v]=o.useState({client_id:"",oggetto_trattativa:"",valore_stimato:0,data_apertura:new Date().toISOString().split("T")[0],stato_trattativa:"in_corso",scadenza_prossimo_contatto:"",note:""}),[m,g]=o.useState({});o.useEffect(()=>{h()},[]),o.useEffect(()=>{var s;r&&v({client_id:r.client_id,oggetto_trattativa:r.oggetto_trattativa,valore_stimato:r.valore_stimato,data_apertura:r.data_apertura.split("T")[0],stato_trattativa:r.stato_trattativa,scadenza_prossimo_contatto:((s=r.scadenza_prossimo_contatto)==null?void 0:s.split("T")[0])||"",note:r.note||""})},[r]);const h=async()=>{try{const s=await F.getAll();N(s)}catch(s){console.error("Error loading clients:",s),x.error("Errore nel caricamento dei clienti")}},u=s=>{s.preventDefault(),g({});try{const c={client_id:a.client_id,oggetto_trattativa:a.oggetto_trattativa,valore_stimato:a.valore_stimato,data_apertura:a.data_apertura,stato_trattativa:a.stato_trattativa,scadenza_prossimo_contatto:a.scadenza_prossimo_contatto||void 0,note:a.note||void 0};A.parse(c);const n={...a,data_apertura:new Date(a.data_apertura).toISOString(),scadenza_prossimo_contatto:a.scadenza_prossimo_contatto?new Date(a.scadenza_prossimo_contatto).toISOString():void 0,user_id:"default-user"};b(n)}catch(c){if(c instanceof I){const n={};c.errors.forEach(d=>{d.path[0]&&(n[d.path[0]]=d.message)}),g(n),x.error("Controlla i campi del form")}}},l=s=>{const{name:c,value:n}=s.target;v(d=>({...d,[c]:c==="valore_stimato"?parseFloat(n)||0:n}))};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:e.jsxs("div",{className:"bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-gray-200",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:r?"Modifica Trattativa":"Nuova Trattativa"}),e.jsx("button",{onClick:p,className:"text-gray-400 hover:text-gray-600 transition-colors",children:e.jsx(k,{className:"w-6 h-6"})})]}),e.jsxs("form",{onSubmit:u,className:"p-6 space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Cliente *"}),e.jsxs("select",{name:"client_id",value:a.client_id,onChange:l,required:!0,className:`w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent ${m.client_id?"border-red-500":"border-gray-300"}`,children:[e.jsx("option",{value:"",children:"Seleziona un cliente"}),j.map(s=>e.jsxs("option",{value:s.id,children:[s.nome_azienda," - ",s.figura_preposta]},s.id))]}),m.client_id&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:m.client_id})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Valore Stimato (€) *"}),e.jsx("input",{type:"number",name:"valore_stimato",value:a.valore_stimato,onChange:l,required:!0,min:"0",step:"0.01",className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Oggetto Trattativa *"}),e.jsx("input",{type:"text",name:"oggetto_trattativa",value:a.oggetto_trattativa,onChange:l,required:!0,placeholder:"es: E-commerce + ADV",className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Data Apertura *"}),e.jsx("input",{type:"date",name:"data_apertura",value:a.data_apertura,onChange:l,required:!0,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Stato Trattativa *"}),e.jsxs("select",{name:"stato_trattativa",value:a.stato_trattativa,onChange:l,required:!0,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent",children:[e.jsx("option",{value:"in_corso",children:"In Corso"}),e.jsx("option",{value:"vinta",children:"Vinta"}),e.jsx("option",{value:"persa",children:"Persa"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Scadenza Prossimo Contatto"}),e.jsx("input",{type:"date",name:"scadenza_prossimo_contatto",value:a.scadenza_prossimo_contatto,onChange:l,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Note"}),e.jsx("textarea",{name:"note",value:a.note,onChange:l,rows:4,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]}),e.jsxs("div",{className:"flex justify-end space-x-3 pt-4",children:[e.jsx("button",{type:"button",onClick:p,className:"px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-md transition-colors",children:"Annulla"}),e.jsxs("button",{type:"submit",className:"px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-md transition-colors",children:[r?"Aggiorna":"Crea"," Trattativa"]})]})]})]})})},Q=()=>{const[r,b]=o.useState([]),[p,j]=o.useState([]),[N,a]=o.useState(!0),[v,m]=o.useState(!1),[g,h]=o.useState(),[u,l]=o.useState(""),[s,c]=o.useState("all");o.useEffect(()=>{d()},[]);const n=o.useCallback(()=>{let t=r;u&&(t=t.filter(i=>{var f;return i.oggetto_trattativa.toLowerCase().includes(u.toLowerCase())||((f=i.client)==null?void 0:f.nome_azienda.toLowerCase().includes(u.toLowerCase()))})),s!=="all"&&(t=t.filter(i=>i.stato_trattativa===s)),j(t)},[r,u,s]);o.useEffect(()=>{n()},[n]);const d=async()=>{try{a(!0);const t=await y.getAll();b(t)}catch(t){console.error("Error loading deals:",t),x.error("Errore nel caricamento delle trattative")}finally{a(!1)}},S=async t=>{try{g?(await y.update(g.id,t),x.success("Trattativa aggiornata con successo!")):(await y.create(t),x.success("Trattativa creata con successo!")),await d(),m(!1),h(void 0)}catch(i){console.error("Error saving deal:",i),x.error("Errore nel salvataggio della trattativa")}},C=t=>{h(t),m(!0)},E=async t=>{if(window.confirm("Sei sicuro di voler eliminare questa trattativa?"))try{await y.delete(t),await d(),x.success("Trattativa eliminata con successo!")}catch(i){console.error("Error deleting deal:",i),x.error("Errore nell'eliminazione della trattativa")}},z=t=>{switch(t){case"in_corso":return"bg-blue-100 text-blue-800";case"vinta":return"bg-green-100 text-green-800";case"persa":return"bg-red-100 text-red-800";default:return"bg-gray-100 text-gray-800"}},D=t=>new Intl.NumberFormat("it-IT",{style:"currency",currency:"EUR"}).format(t),_=t=>M(new Date(t),"dd/MM/yyyy",{locale:B});return N?e.jsx("div",{className:"p-6",children:e.jsx("div",{className:"animate-pulse space-y-4",children:[...Array(5)].map((t,i)=>e.jsx("div",{className:"bg-gray-200 h-16 rounded-lg"},i))})}):e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Trattative"}),e.jsx("p",{className:"text-gray-600 mt-1",children:"Gestisci le tue opportunità commerciali"})]}),e.jsxs("button",{onClick:()=>m(!0),className:"bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center space-x-2 transition-colors",children:[e.jsx(q,{className:"w-4 h-4"}),e.jsx("span",{children:"Nuova Trattativa"})]})]}),e.jsx("div",{className:"bg-white rounded-lg shadow-md p-4 mb-6",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx(P,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"}),e.jsx("input",{type:"text",placeholder:"Cerca trattative...",value:u,onChange:t=>l(t.target.value),className:"w-full pl-10 pr-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]}),e.jsxs("select",{value:s,onChange:t=>c(t.target.value),className:"px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent",children:[e.jsx("option",{value:"all",children:"Tutti gli stati"}),e.jsx("option",{value:"in_corso",children:"In Corso"}),e.jsx("option",{value:"vinta",children:"Vinta"}),e.jsx("option",{value:"persa",children:"Persa"})]}),e.jsxs("div",{className:"text-sm text-gray-600 flex items-center",children:[p.length," di ",r.length," trattative"]})]})}),e.jsx("div",{className:"bg-white rounded-lg shadow-md overflow-hidden",children:p.length>0?e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Trattativa"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Cliente"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Valore"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Stato"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Date"}),e.jsx("th",{className:"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Azioni"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:p.map(t=>{var i,f;return e.jsxs("tr",{className:"hover:bg-gray-50 transition-colors",children:[e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap",children:[e.jsx("div",{className:"text-sm font-medium text-gray-900",children:t.oggetto_trattativa}),t.note&&e.jsx("div",{className:"text-sm text-gray-500 truncate max-w-xs",children:t.note})]}),e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap",children:[e.jsx("div",{className:"text-sm text-gray-900",children:(i=t.client)==null?void 0:i.nome_azienda}),e.jsx("div",{className:"text-sm text-gray-500",children:(f=t.client)==null?void 0:f.figura_preposta})]}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(O,{className:"w-4 h-4 text-gray-400 mr-1"}),e.jsx("span",{className:"text-sm font-medium text-gray-900",children:D(t.valore_stimato)})]})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("span",{className:`inline-flex px-2 py-1 text-xs font-semibold rounded-full ${z(t.stato_trattativa)}`,children:t.stato_trattativa.replace("_"," ").toUpperCase()})}),e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(w,{className:"w-4 h-4 mr-1"}),e.jsxs("span",{children:["Aperta: ",_(t.data_apertura)]})]}),t.scadenza_prossimo_contatto&&e.jsxs("div",{className:"flex items-center mt-1",children:[e.jsx(w,{className:"w-4 h-4 mr-1 text-orange-500"}),e.jsxs("span",{className:"text-orange-600",children:["Follow-up: ",_(t.scadenza_prossimo_contatto)]})]})]}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-right text-sm font-medium",children:e.jsxs("div",{className:"flex items-center justify-end space-x-2",children:[e.jsx("button",{onClick:()=>C(t),className:"text-blue-600 hover:text-blue-900 transition-colors",children:e.jsx(L,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>E(t.id),className:"text-red-600 hover:text-red-900 transition-colors",children:e.jsx(V,{className:"w-4 h-4"})})]})})]},t.id)})})]})}):e.jsxs("div",{className:"text-center py-12",children:[e.jsx(T,{className:"mx-auto h-12 w-12 text-gray-400"}),e.jsx("h3",{className:"mt-2 text-sm font-medium text-gray-900",children:"Nessuna trattativa trovata"}),e.jsx("p",{className:"mt-1 text-sm text-gray-500",children:u||s!=="all"?"Prova a modificare i filtri di ricerca":"Inizia aggiungendo una nuova trattativa"})]})}),v&&e.jsx(R,{deal:g,onSubmit:S,onClose:()=>{m(!1),h(void 0)}})]})};export{Q as default};
