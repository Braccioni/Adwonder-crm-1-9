import{s as c,e as s}from"./index-DgQnJBRP.js";import{c as _,g as v,d as g,i as h}from"./cacheManager-C0Kc18OK.js";const f=e=>{var t,a,n;return(e==null?void 0:e.code)==="PGRST116"||((t=e==null?void 0:e.message)==null?void 0:t.includes("relation"))&&((a=e==null?void 0:e.message)==null?void 0:a.includes("does not exist"))||(e==null?void 0:e.code)==="42P01"||((n=e==null?void 0:e.details)==null?void 0:n.includes("does not exist"))},w=e=>{const t=[];return e.nome_azienda&&typeof e.nome_azienda!="string"&&t.push("Nome azienda deve essere una stringa"),e.nome_azienda&&e.nome_azienda.trim().length<2&&t.push("Nome azienda deve avere almeno 2 caratteri"),e.indirizzo_mail&&typeof e.indirizzo_mail!="string"&&t.push("Email deve essere una stringa"),e.indirizzo_mail&&!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e.indirizzo_mail)&&t.push("Email non valida"),e.contatti&&typeof e.contatti!="string"&&t.push("Contatti deve essere una stringa"),e.contatti&&e.contatti.trim().length>0&&!/^[+]?[0-9\s\-()]+$/.test(e.contatti)&&t.push("Formato contatti non valido"),e.figura_preposta&&typeof e.figura_preposta!="string"&&t.push("Figura preposta deve essere una stringa"),e.valore_mensile&&(typeof e.valore_mensile!="number"||e.valore_mensile<0)&&t.push("Valore mensile deve essere un numero positivo"),e.valore_spot&&(typeof e.valore_spot!="number"||e.valore_spot<0)&&t.push("Valore spot deve essere un numero positivo"),{isValid:t.length===0,errors:t}},z=e=>{const t=[];return(!e.nome_azienda||e.nome_azienda.trim().length===0)&&t.push("Nome azienda è obbligatorio"),(!e.indirizzo_mail||e.indirizzo_mail.trim().length===0)&&t.push("Email è obbligatoria"),e.stato_trattativa||t.push("Stato trattativa è obbligatorio"),e.user_id||t.push("User ID è obbligatorio"),{isValid:t.length===0,errors:t}},C={async getAll(){try{const e=_.get("clients");if(e)return e;const t=await v(g,async()=>{const{data:a,error:n}=await c.from("clients").select("*").order("created_at",{ascending:!1});if(n)throw f(n)?(console.warn("Clients table not configured yet. Using mock data."),new Error("Table not configured")):n;return a||[]});return _.set("clients",t),t}catch(e){return console.warn("Client service error:",e),s.handleReadError(e,"fetch clients",g)}},async getById(e){try{const{data:t,error:a}=await c.from("clients").select("*").eq("id",e).single();return a?f(a)?(console.warn("Clients table not configured yet."),null):s.handleReadError(a,"fetch client by ID",null):t}catch(t){return console.warn("Client service not available:",t),null}},async create(e){var t,a,n,o;try{const i=z(e);if(!i.isValid)throw new Error(`Validation failed: ${i.errors.join(", ")}`);const m=w(e);if(!m.isValid)throw new Error(`Validation failed: ${m.errors.join(", ")}`);const r={...{...e,nome_azienda:e.nome_azienda.trim(),indirizzo_mail:e.indirizzo_mail.toLowerCase().trim(),contatti:((t=e.contatti)==null?void 0:t.trim())||null,figura_preposta:((a=e.figura_preposta)==null?void 0:a.trim())||null},created_at:new Date().toISOString(),updated_at:new Date().toISOString()},{data:u,error:d}=await c.from("clients").insert([r]).select().single();if(d)throw f(d)?(console.warn("Clients table not configured yet."),new Error("Database not configured")):(s.handleWriteError(d,"creazione cliente"),d);return h(),s.handleSuccess("create"),u}catch(i){throw(n=i.message)!=null&&n.includes("Validation failed")||(o=i.message)!=null&&o.includes("Database not configured")||s.handleWriteError(i,"creazione cliente"),i}},async update(e,t){var a,n,o,i,m;try{if(!e||typeof e!="string"||e.trim().length===0)throw new Error("ID cliente non valido");const l=w(t);if(!l.isValid)throw new Error(`Validation failed: ${l.errors.join(", ")}`);const r={};t.nome_azienda!==void 0&&(r.nome_azienda=t.nome_azienda.trim()),t.indirizzo_mail!==void 0&&(r.indirizzo_mail=t.indirizzo_mail.toLowerCase().trim()),t.contatti!==void 0&&(r.contatti=((a=t.contatti)==null?void 0:a.trim())||null),t.figura_preposta!==void 0&&(r.figura_preposta=((n=t.figura_preposta)==null?void 0:n.trim())||null),t.valore_mensile!==void 0&&(r.valore_mensile=t.valore_mensile),t.valore_spot!==void 0&&(r.valore_spot=t.valore_spot),t.data_scadenza_contratto!==void 0&&(r.data_scadenza_contratto=t.data_scadenza_contratto),t.stato_trattativa!==void 0&&(r.stato_trattativa=t.stato_trattativa);const{data:u,error:d}=await c.from("clients").update({...r,updated_at:new Date().toISOString()}).eq("id",e).select().single();if(d)throw f(d)?(console.warn("Clients table not configured yet."),new Error("Database not configured")):(s.handleWriteError(d,"aggiornamento cliente"),d);return h(),s.handleSuccess("update"),u}catch(l){throw(o=l.message)!=null&&o.includes("Validation failed")||(i=l.message)!=null&&i.includes("Database not configured")||(m=l.message)!=null&&m.includes("ID cliente non valido")||s.handleWriteError(l,"aggiornamento cliente"),l}},async delete(e){var t,a,n;try{if(!e||typeof e!="string"||e.trim().length===0)throw new Error("ID cliente non valido");if(!await this.getById(e))throw new Error("Cliente non trovato");const{error:i}=await c.from("clients").delete().eq("id",e);if(i)throw f(i)?(console.warn("Clients table not configured yet."),new Error("Database not configured")):(s.handleWriteError(i,"eliminazione cliente"),i);h(),s.handleSuccess("delete")}catch(o){throw(t=o.message)!=null&&t.includes("Database not configured")||(a=o.message)!=null&&a.includes("ID cliente non valido")||(n=o.message)!=null&&n.includes("Cliente non trovato")||s.handleWriteError(o,"eliminazione cliente"),o}},async validateEmail(e){try{const{data:t}=await c.from("clients").select("id").eq("indirizzo_mail",e.toLowerCase().trim()).limit(1);return((t==null?void 0:t.length)||0)===0}catch(t){return console.warn("Email validation failed:",t),!0}},async searchClients(e){try{if(!e||e.trim().length<2)return[];const t=`%${e.trim()}%`,{data:a,error:n}=await c.from("clients").select("*").or(`nome_azienda.ilike.${t},indirizzo_mail.ilike.${t},figura_preposta.ilike.${t}`).order("created_at",{ascending:!1}).limit(20);if(n){if(f(n)){const o=e.toLowerCase();return g.filter(i=>i.nome_azienda.toLowerCase().includes(o)||i.indirizzo_mail.toLowerCase().includes(o)||i.figura_preposta&&i.figura_preposta.toLowerCase().includes(o)).slice(0,20)}throw n}return a||[]}catch(t){return console.warn("Client search error:",t),[]}}};export{C as c};
