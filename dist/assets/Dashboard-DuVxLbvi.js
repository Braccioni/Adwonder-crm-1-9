import{c as S,j as t,l as u,s as _,n as V,e as q,r as v,A as z,U as L,B as F,C as O,a as $}from"./index-DgQnJBRP.js";import{d as G}from"./dealService-BGrHSSP5.js";import{c as h,s as H,a as J,m as N,b as D}from"./cacheManager-C0Kc18OK.js";import{T as K}from"./trending-up-D6j6YnG3.js";import{E as Q}from"./euro-ho5eT_Bs.js";/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const W=S("Award",[["circle",{cx:"12",cy:"8",r:"6",key:"1vp47v"}],["path",{d:"M15.477 12.89 17 22l-5-3-5 3 1.523-9.11",key:"em7aur"}]]);/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const X=S("RefreshCw",[["path",{d:"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8",key:"v9h5vc"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}],["path",{d:"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16",key:"3uifl3"}],["path",{d:"M8 16H3v5",key:"1cv678"}]]);/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Y=S("Star",[["polygon",{points:"12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2",key:"8f66p6"}]]);/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Z=S("TrendingDown",[["polyline",{points:"22 17 13.5 8.5 8.5 13.5 2 7",key:"1r2t7k"}],["polyline",{points:"16 17 22 17 22 11",key:"11uiuu"}]]),b=({title:e,value:s,icon:r,color:n,subtitle:l})=>{const i={blue:"bg-blue-500",green:"bg-green-500",red:"bg-red-500",yellow:"bg-yellow-500",purple:"bg-purple-500"};return t.jsx("div",{className:"bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow",children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{children:[t.jsx("p",{className:"text-sm font-medium text-gray-600",children:e}),t.jsx("p",{className:"text-2xl font-bold text-gray-900 mt-1",children:s}),l&&t.jsx("p",{className:"text-sm text-gray-500 mt-1",children:l})]}),t.jsx("div",{className:`${i[n]} p-3 rounded-full text-white`,children:t.jsx(r,{className:"w-6 h-6"})})]})})},y=e=>{var s,r,n;return(e==null?void 0:e.code)==="PGRST116"||((s=e==null?void 0:e.message)==null?void 0:s.includes("relation"))&&((r=e==null?void 0:e.message)==null?void 0:r.includes("does not exist"))||(e==null?void 0:e.code)==="42P01"||((n=e==null?void 0:e.details)==null?void 0:n.includes("does not exist"))},ee=e=>{var s,r;return(e==null?void 0:e.code)==="PGRST203"||((s=e==null?void 0:e.message)==null?void 0:s.includes("column"))&&((r=e==null?void 0:e.message)==null?void 0:r.includes("does not exist"))},te={async getStats(){const e=performance.now();u.info("Starting dashboard stats retrieval","dashboard");try{const{count:s,error:r}=await _.from("clients").select("*",{count:"exact",head:!0});let n=0;r?y(r)?u.debug("Clients table not configured","dashboard"):u.warn("Error fetching clients count","dashboard",{error:r}):(n=s||0,u.debug("Clients count retrieved","dashboard",{count:n}));const{count:l,error:i}=await _.from("deals").select("*",{count:"exact",head:!0}).eq("stato_trattativa","in_corso");let c=0;i?y(i)?u.debug("Deals table not configured","dashboard"):u.warn("Error fetching active deals","dashboard",{error:i}):(c=l||0,u.debug("Active deals count retrieved","dashboard",{count:c}));const{count:a,error:o}=await _.from("deals").select("*",{count:"exact",head:!0}).eq("stato_trattativa","vinta");let d=0;o?y(o)||console.warn("Error fetching won deals:",o):d=a||0;const{count:w,error:p}=await _.from("deals").select("*",{count:"exact",head:!0}).eq("stato_trattativa","persa");let x=0;p?y(p)||console.warn("Error fetching lost deals:",p):x=w||0;const{data:g,error:m}=await _.from("deals").select("valore_stimato").eq("stato_trattativa","in_corso");let f=0;m?!y(m)&&!ee(m)&&console.warn("Error fetching deal values:",m):f=(g==null?void 0:g.reduce((k,U)=>k+U.valore_stimato,0))||0;const j=new Date;j.setDate(j.getDate()-j.getDay()),j.setHours(0,0,0,0);const{count:B,error:C}=await _.from("activities").select("*",{count:"exact",head:!0}).gte("data_ora",j.toISOString());let M=0;C?y(C)||console.warn("Error fetching activities:",C):M=B||0;let E={pending:0,expiring_soon:0};try{E=await V.getNotificationCount()}catch(k){console.warn("Error fetching notification counts:",k)}const P=await this.getBestClientByRevenue(),A=await this.getBestClientByContractDuration(),R=await this.getBestSalesPerformance(),I={total_clients:n,active_deals:c,won_deals:d,lost_deals:x,total_deal_value:f,this_week_activities:M,pending_notifications:E.pending,contracts_expiring_soon:E.expiring_soon,best_client_by_revenue:P||void 0,best_client_by_contract_duration:A||void 0,best_sales_performance:R||void 0},T=performance.now()-e;return u.info("Dashboard stats retrieved successfully","dashboard",{duration:`${T.toFixed(2)}ms`,stats:{total_clients:n,active_deals:c,total_deal_value:f}}),q.logPerformanceIssue("dashboard-stats",T,2e3),I}catch(s){const r=performance.now()-e;u.error("Dashboard stats retrieval failed","dashboard",{duration:`${r.toFixed(2)}ms`,error:s.message||"Unknown error"},s instanceof Error?s:void 0);const n={total_clients:0,active_deals:0,won_deals:0,lost_deals:0,total_deal_value:0,this_week_activities:0,pending_notifications:0,contracts_expiring_soon:0};return u.warn("Using fallback dashboard stats","dashboard",n),n}},async getBestClientByRevenue(){try{const{data:e}=await _.from("deals").select(`
          valore_stimato,
          clients!inner(nome_azienda)
        `).eq("stato_trattativa","vinta");if(!e||e.length===0)return;const s=e.reduce((n,l)=>{var c;const i=(c=l.clients)==null?void 0:c.nome_azienda;return i&&l.valore_stimato&&(n[i]=(n[i]||0)+Number(l.valore_stimato)),n},{}),r=Object.entries(s).reduce((n,[l,i])=>i>n.total_revenue?{nome_azienda:l,total_revenue:i}:n,{nome_azienda:"",total_revenue:0});return r.nome_azienda?r:void 0}catch(e){console.warn("Error getting best client by revenue:",e);return}},async getBestClientByContractDuration(){try{const{data:e}=await _.from("clients").select("nome_azienda, durata_contratto_mesi").not("durata_contratto_mesi","is",null).order("durata_contratto_mesi",{ascending:!1}).limit(1);return!e||e.length===0?void 0:{nome_azienda:e[0].nome_azienda,contract_duration_months:e[0].durata_contratto_mesi}}catch(e){console.warn("Error getting best client by contract duration:",e);return}},async getBestSalesPerformance(){var e;try{const{data:s}=await _.from("deals").select("valore_stimato, data_apertura, oggetto_trattativa, clients!inner(nome_azienda)").eq("stato_trattativa","vinta");if(!s||s.length===0)return;const r={};s.forEach(a=>{if(a.data_apertura&&a.valore_stimato){const o=new Date(a.data_apertura).toISOString().slice(0,7);r[o]||(r[o]={deals_count:0,total_value:0}),r[o].deals_count++,r[o].total_value+=Number(a.valore_stimato)}});const n=Object.entries(r).reduce((a,[o,d])=>d.deals_count>a.deals_count?{month:o,...d}:a,{month:"",deals_count:0,total_value:0}),l={};s.forEach(a=>{if(a.data_apertura){const o=a.data_apertura.split("T")[0];l[o]=(l[o]||0)+1}});const i=Object.entries(l).reduce((a,[o,d])=>d>a.deals_count?{date:o,deals_count:d}:a,{date:"",deals_count:0}),c=s.reduce((a,o)=>{const d=Number(o.valore_stimato)||0,w=Number(a.valore_stimato)||0;return d>w?o:a},s[0]||{});return{best_month:n.month?{month:n.month,deals_count:n.deals_count,total_value:n.total_value}:void 0,best_day:i.date?{date:i.date,deals_count:i.deals_count}:void 0,biggest_deal:c.oggetto_trattativa?{oggetto_trattativa:c.oggetto_trattativa,valore_stimato:Number(c.valore_stimato),client_name:(e=c.clients)==null?void 0:e.nome_azienda}:void 0}}catch(s){console.warn("Error getting best sales performance:",s);return}}},ae=()=>{const[e,s]=v.useState(null),[r,n]=v.useState([]),[l,i]=v.useState(!0),[c,a]=v.useState(null),o=v.useCallback(async(w=!1)=>{try{if(i(!0),a(null),!w){const m=h.get("dashboard"),f=h.get("deals");if(m&&f){s(m),n(f.slice(0,5)),i(!1);return}}if(await H()){await J(300),h.set("dashboard",N,["clients","deals","activities","notifications"]),h.set("deals",D,["clients"]),s(N),n(D.slice(0,5)),i(!1);return}const[x,g]=await Promise.all([te.getStats().catch(m=>(console.warn("Error loading dashboard stats:",m),N)),G.getAll().catch(m=>(console.warn("Error loading deals:",m),D))]);h.set("dashboard",x,["clients","deals","activities","notifications"]),h.set("deals",g,["clients"]),s(x),n(g.slice(0,5))}catch(p){console.error("Error loading dashboard data:",p),a("Errore nel caricamento dei dati del dashboard");const x=h.get("dashboard")||N,g=h.get("deals")||D;s(x),n(g.slice(0,5))}finally{i(!1)}},[]),d=v.useCallback(async()=>{await o(!0)},[o]);return v.useEffect(()=>{o()},[o]),{stats:e,recentDeals:r,loading:l,error:c,refreshData:d}},le=()=>{const{stats:e,recentDeals:s,loading:r,error:n,refreshData:l}=ae();if(r)return t.jsx("div",{className:"p-6",children:t.jsx("div",{className:"animate-pulse",children:t.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:[...Array(8)].map((a,o)=>t.jsx("div",{className:"bg-gray-200 h-32 rounded-lg"},o))})})});if(!e)return null;const i=a=>new Intl.NumberFormat("it-IT",{style:"currency",currency:"EUR"}).format(a),c=a=>{switch(a){case"vinta":return"text-green-600 bg-green-100";case"persa":return"text-red-600 bg-red-100";case"in_corso":return"text-blue-600 bg-blue-100";default:return"text-gray-600 bg-gray-100"}};return t.jsxs("div",{className:"p-6 space-y-6",children:[t.jsxs("div",{className:"flex justify-between items-center",children:[t.jsxs("div",{children:[t.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Dashboard"}),t.jsx("p",{className:"text-gray-600 mt-1",children:"Panoramica delle performance commerciali"}),n&&t.jsxs("p",{className:"text-amber-600 text-sm mt-1 flex items-center",children:[t.jsx(z,{className:"w-4 h-4 mr-1"}),n," - Visualizzazione dati di esempio"]})]}),t.jsxs("button",{onClick:l,className:"flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors",disabled:r,children:[t.jsx(X,{className:`w-4 h-4 mr-2 ${r?"animate-spin":""}`}),"Aggiorna"]})]}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6",children:[t.jsx(b,{title:"Clienti Totali",value:e.total_clients,icon:L,color:"blue"}),t.jsx(b,{title:"Trattative Attive",value:e.active_deals,icon:F,color:"yellow"}),t.jsx(b,{title:"Trattative Vinte",value:e.won_deals,icon:K,color:"green"}),t.jsx(b,{title:"Trattative Perse",value:e.lost_deals,icon:Z,color:"red"}),t.jsx(b,{title:"Valore Pipeline",value:i(e.total_deal_value),icon:Q,color:"purple"}),t.jsx(b,{title:"Attività Settimana",value:e.this_week_activities,icon:O,color:"purple"}),t.jsx(b,{title:"Notifiche Pendenti",value:e.pending_notifications,icon:$,color:"yellow"}),t.jsx(b,{title:"Contratti in Scadenza",value:e.contracts_expiring_soon,icon:z,color:"red"})]}),t.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[t.jsxs("div",{className:"bg-white rounded-lg shadow-md",children:[t.jsx("div",{className:"px-6 py-4 border-b border-gray-200",children:t.jsxs("h2",{className:"text-lg font-semibold text-gray-900 flex items-center",children:[t.jsx(W,{className:"w-5 h-5 mr-2 text-yellow-500"}),"Migliori Clienti"]})}),t.jsxs("div",{className:"p-6 space-y-4",children:[e.best_client_by_revenue&&t.jsxs("div",{className:"bg-green-50 p-4 rounded-lg",children:[t.jsx("h3",{className:"font-medium text-green-800 mb-2",children:"🏆 Migliore per Fatturato"}),t.jsx("p",{className:"text-green-700 font-semibold",children:e.best_client_by_revenue.nome_azienda}),t.jsx("p",{className:"text-green-600 text-sm",children:i(e.best_client_by_revenue.total_revenue)})]}),e.best_client_by_contract_duration&&t.jsxs("div",{className:"bg-blue-50 p-4 rounded-lg",children:[t.jsx("h3",{className:"font-medium text-blue-800 mb-2",children:"⏱️ Migliore per Durata Contratto"}),t.jsx("p",{className:"text-blue-700 font-semibold",children:e.best_client_by_contract_duration.nome_azienda}),t.jsxs("p",{className:"text-blue-600 text-sm",children:[e.best_client_by_contract_duration.contract_duration_months," mesi"]})]}),!e.best_client_by_revenue&&!e.best_client_by_contract_duration&&t.jsx("p",{className:"text-gray-500 text-center py-4",children:"Nessun dato disponibile"})]})]}),t.jsxs("div",{className:"bg-white rounded-lg shadow-md",children:[t.jsx("div",{className:"px-6 py-4 border-b border-gray-200",children:t.jsxs("h2",{className:"text-lg font-semibold text-gray-900 flex items-center",children:[t.jsx(Y,{className:"w-5 h-5 mr-2 text-purple-500"}),"Performance di Vendita"]})}),t.jsx("div",{className:"p-6 space-y-4",children:e.best_sales_performance?t.jsxs(t.Fragment,{children:[e.best_sales_performance.best_month.month&&t.jsxs("div",{className:"bg-purple-50 p-4 rounded-lg",children:[t.jsx("h3",{className:"font-medium text-purple-800 mb-2",children:"📅 Mese Migliore"}),t.jsx("p",{className:"text-purple-700 font-semibold",children:new Date(e.best_sales_performance.best_month.month+"-01").toLocaleDateString("it-IT",{year:"numeric",month:"long"})}),t.jsxs("p",{className:"text-purple-600 text-sm",children:[e.best_sales_performance.best_month.deals_count," trattative - ",i(e.best_sales_performance.best_month.total_value)]})]}),e.best_sales_performance.best_day.date&&t.jsxs("div",{className:"bg-orange-50 p-4 rounded-lg",children:[t.jsx("h3",{className:"font-medium text-orange-800 mb-2",children:"🗓️ Giorno Migliore"}),t.jsx("p",{className:"text-orange-700 font-semibold",children:new Date(e.best_sales_performance.best_day.date).toLocaleDateString("it-IT")}),t.jsxs("p",{className:"text-orange-600 text-sm",children:[e.best_sales_performance.best_day.deals_count," trattative chiuse"]})]}),e.best_sales_performance.biggest_deal.oggetto_trattativa&&t.jsxs("div",{className:"bg-yellow-50 p-4 rounded-lg",children:[t.jsx("h3",{className:"font-medium text-yellow-800 mb-2",children:"💰 Vendita Migliore"}),t.jsx("p",{className:"text-yellow-700 font-semibold",children:e.best_sales_performance.biggest_deal.oggetto_trattativa}),t.jsxs("p",{className:"text-yellow-600 text-sm",children:[i(e.best_sales_performance.biggest_deal.valore_stimato)," - ",e.best_sales_performance.biggest_deal.client_name]})]})]}):t.jsx("p",{className:"text-gray-500 text-center py-4",children:"Nessun dato disponibile"})})]})]}),t.jsxs("div",{className:"bg-white rounded-lg shadow-md",children:[t.jsx("div",{className:"px-6 py-4 border-b border-gray-200",children:t.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Trattative Recenti"})}),t.jsx("div",{className:"p-6",children:s.length>0?t.jsx("div",{className:"space-y-4",children:s.map(a=>{var o;return t.jsxs("div",{className:"flex items-center justify-between p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors",children:[t.jsxs("div",{className:"flex-1",children:[t.jsx("h3",{className:"font-medium text-gray-900",children:a.oggetto_trattativa}),t.jsx("p",{className:"text-sm text-gray-600",children:(o=a.client)==null?void 0:o.nome_azienda})]}),t.jsxs("div",{className:"flex items-center space-x-4",children:[t.jsx("span",{className:"font-medium text-gray-900",children:i(a.valore_stimato)}),t.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-medium ${c(a.stato_trattativa)}`,children:a.stato_trattativa.replace("_"," ").toUpperCase()})]})]},a.id)})}):t.jsx("p",{className:"text-gray-500 text-center py-8",children:"Nessuna trattativa disponibile"})})]})]})};export{le as default};
